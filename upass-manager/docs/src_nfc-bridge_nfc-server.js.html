<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>src/nfc-bridge/nfc-server.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/yourusername/upass-manager" target="_blank" >GitHub</a></h2><h3>Modules</h3><ul><li><a href="module-api_search-by-pid.html">api/search-by-pid</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_search-by-pid.html#~handler">handler</a></li></ul></li><li><a href="module-app_components_DisclaimerModal.html">app/components/DisclaimerModal</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-app_components_DisclaimerModal.html#~DisclaimerModal">DisclaimerModal</a></li></ul></li><li><a href="module-app_components_EditStudentModal.html">app/components/EditStudentModal</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-app_components_EditStudentModal.html#~EditStudentModal">EditStudentModal</a></li></ul></li><li><a href="module-app_components_Footer.html">app/components/Footer</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-app_components_Footer.html#~Footer">Footer</a></li></ul></li><li><a href="module-app_components_MessageTemplateModal.html">app/components/MessageTemplateModal</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-app_components_MessageTemplateModal.html#~MessageTemplateModal">MessageTemplateModal</a></li></ul></li><li><a href="module-app_components_NFCModal.html">app/components/NFCModal</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-app_components_NFCModal.html#~NFCModal">NFCModal</a></li></ul></li><li><a href="module-app_components_UploadModal.html">app/components/UploadModal</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-app_components_UploadModal.html#~UploadModal">UploadModal</a></li></ul></li><li><a href="module-app_components_ViewStudentModal.html">app/components/ViewStudentModal</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-app_components_ViewStudentModal.html#~ViewStudentModal">ViewStudentModal</a></li></ul></li><li><a href="module-app_components_VisualizationOptionsModal.html">app/components/VisualizationOptionsModal</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-app_components_VisualizationOptionsModal.html#~VisualizationOptionsModal">VisualizationOptionsModal</a></li></ul></li><li><a href="module-backend-api_db.html">backend-api/db</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-backend-api_db.html#~executeQuery">executeQuery</a></li></ul></li><li><a href="module-backend-api_pages_api_get-all-records.html">backend-api/pages/api/get-all-records</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-backend-api_pages_api_get-all-records.html#~handler">handler</a></li></ul></li><li><a href="module-backend-api_pages_api_login.html">backend-api/pages/api/login</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-backend-api_pages_api_login.html#~handler">handler</a></li></ul></li><li><a href="module-backend-api_pages_api_message-templates.html">backend-api/pages/api/message-templates</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-backend-api_pages_api_message-templates.html#~createTemplate">createTemplate</a></li><li data-type='method' style='display: none;'><a href="module-backend-api_pages_api_message-templates.html#~deleteTemplate">deleteTemplate</a></li><li data-type='method' style='display: none;'><a href="module-backend-api_pages_api_message-templates.html#~getTemplates">getTemplates</a></li><li data-type='method' style='display: none;'><a href="module-backend-api_pages_api_message-templates.html#~handler">handler</a></li><li data-type='method' style='display: none;'><a href="module-backend-api_pages_api_message-templates.html#~updateTemplate">updateTemplate</a></li></ul></li><li><a href="module-backend-api_pages_api_send-notification.html">backend-api/pages/api/send-notification</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-backend-api_pages_api_send-notification.html#~handler">handler</a></li></ul></li><li><a href="module-backend-api_pages_api_update-student.html">backend-api/pages/api/update-student</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-backend-api_pages_api_update-student.html#~handler">handler</a></li></ul></li><li><a href="module-backend-api_update-disclaimer.html">backend-api/update-disclaimer</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-backend-api_update-disclaimer.html#~handler">handler</a></li></ul></li><li><a href="module-backend-common_auth.html">backend-common/auth</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-backend-common_auth.html#.authenticateUser">authenticateUser</a></li><li data-type='method' style='display: none;'><a href="module-backend-common_auth.html#.verifyToken">verifyToken</a></li></ul></li><li><a href="module-components_AddDistributorModal.html">components/AddDistributorModal</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-components_AddDistributorModal.html#~AddDistributorModal">AddDistributorModal</a></li><li data-type='method' style='display: none;'><a href="module-components_AddDistributorModal.html#~handleSubmit">handleSubmit</a></li></ul></li><li><a href="module-context_LoadingContext.html">context/LoadingContext</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-context_LoadingContext.html#.LoadingProvider">LoadingProvider</a></li><li data-type='method' style='display: none;'><a href="module-context_LoadingContext.html#.useLoading">useLoading</a></li></ul></li><li><a href="module-nfc-bridge_nfc-server.html">nfc-bridge/nfc-server</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-nfc-bridge_nfc-server.html#~bytesToHexString">bytesToHexString</a></li><li data-type='method' style='display: none;'><a href="module-nfc-bridge_nfc-server.html#~formatCardNumber">formatCardNumber</a></li><li data-type='method' style='display: none;'><a href="module-nfc-bridge_nfc-server.html#~getChecksum">getChecksum</a></li></ul></li><li><a href="module-views_Dashboard.html">views/Dashboard</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-views_Dashboard.html#~Dashboard">Dashboard</a></li></ul></li><li><a href="module-views_UPassCollectionStats.html">views/UPassCollectionStats</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-views_UPassCollectionStats.html#~CustomTooltip">CustomTooltip</a></li><li data-type='method' style='display: none;'><a href="module-views_UPassCollectionStats.html#~UPassCollectionStats">UPassCollectionStats</a></li><li data-type='method' style='display: none;'><a href="module-views_UPassCollectionStats.html#~applyFilters">applyFilters</a></li><li data-type='method' style='display: none;'><a href="module-views_UPassCollectionStats.html#~fetchData">fetchData</a></li><li data-type='method' style='display: none;'><a href="module-views_UPassCollectionStats.html#~generateDisclaimerSignedData">generateDisclaimerSignedData</a></li><li data-type='method' style='display: none;'><a href="module-views_UPassCollectionStats.html#~generateReplacementData">generateReplacementData</a></li><li data-type='method' style='display: none;'><a href="module-views_UPassCollectionStats.html#~generateUPassCollectionData">generateUPassCollectionData</a></li><li data-type='method' style='display: none;'><a href="module-views_UPassCollectionStats.html#~renderCustomizedLabel">renderCustomizedLabel</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#Header">Header</a></li><li><a href="global.html#HeaderProps">HeaderProps</a></li><li><a href="global.html#allocateUpass">allocateUpass</a></li><li><a href="global.html#maskPid">maskPid</a></li><li><a href="global.html#pcsc">pcsc</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">src/nfc-bridge/nfc-server.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file NFC Bridge Server
 * @description WebSocket server that bridges communication between NFC card readers and the web application
 * @module nfc-bridge/nfc-server
 */

const express = require('express');
const http = require('http');
const socketIo = require('socket.io');
const cors = require('cors');
const pcsc = require('pcsclite');

// Create Express app
const app = express();
app.use(cors());
app.use(express.json());

// Create HTTP server
const server = http.createServer(app);

// Create Socket.IO server
const io = socketIo(server, {
  cors: {
    origin: '*',
    methods: ['GET', 'POST']
  }
});

/**
 * Initialize PC/SC (PC/Smart Card) library for interfacing with NFC readers
 * @type {Object|null} The PC/SC instance or null if initialization failed
 */
let pcscInstance;
try {
  pcscInstance = pcsc();
  console.log('PC/SC initialized successfully');
} catch (error) {
  console.error('Failed to initialize PC/SC:', error.message);
  console.error('Make sure PC/SC drivers are installed and the PC/SC service is running');
  process.exit(1);
}

/**
 * Store active NFC readers
 * @type {Object.&lt;string, Object>} Map of reader names to reader objects
 */
const readers = {};

/**
 * Track if any clients are currently connected
 * @type {boolean}
 */
let isConnected = false;

/**
 * Converts byte array to hexadecimal string
 * 
 * @param {Buffer|Uint8Array} bytes - Array of bytes to convert
 * @returns {string} Hexadecimal string representation
 */
function bytesToHexString(bytes) {
  return Array.from(bytes)
    .map(byte => (byte &lt; 0x10 ? '0' : '') + byte.toString(16).toUpperCase())
    .join('');
}

/**
 * Calculate the checksum for UPass card numbers
 * Uses the same algorithm as in the VBA code
 * 
 * @param {string} value - Card number string to calculate checksum for
 * @returns {number} The calculated checksum digit
 */
function getChecksum(value) {
  const delta = [0, 1, 2, 3, 4, -4, -3, -2, -1, 0];
  let sum = 0;
  
  // Sum all digits
  for (let i = 0; i &lt; value.length; i++) {
    sum += parseInt(value.charAt(i), 10);
  }
  
  // Apply delta values
  let i = value.length - 1;
  while (i >= 0) {
    const deltaIndex = parseInt(value.charAt(i), 10);
    const deltaValue = delta[deltaIndex];
    sum += deltaValue;
    i -= 2;
  }
  
  // Calculate final checksum
  sum = 10 - (sum % 10);
  return sum === 10 ? 0 : sum;
}

/**
 * Format raw card data into a valid UPass card number
 * Uses the same algorithm as in the VBA code
 * 
 * @param {Buffer} data - Raw card data from the NFC reader
 * @returns {string} Formatted 20-digit UPass card number or empty string if invalid
 */
function formatCardNumber(data) {
  // Convert bytes to hex string (skip first byte and last two bytes)
  const hexStr = bytesToHexString(data.slice(1, data.length - 2));
  
  // Convert hex to decimal
  let longVal = 0n;
  for (let i = 0; i &lt; hexStr.length; i++) {
    const hexDigit = hexStr.charAt(hexStr.length - 1 - i);
    const decValue = BigInt(parseInt(hexDigit, 16));
    longVal += decValue * (16n ** BigInt(i));
  }
  
  // Convert to string and pad with leading zeros
  let longStr = longVal.toString();
  while (longStr.length &lt; 15) {
    longStr = '0' + longStr;
  }
  
  // Return empty string if all zeros
  if (longStr === '000000000000000') {
    return '';
  }
  
  // Add prefix and checksum
  longStr = '0167' + longStr;
  return longStr + getChecksum(longStr);
}

/**
 * Handle PC/SC reader events for new readers detected
 * Sets up event handlers for card insertion, removal, and errors
 */
pcscInstance.on('reader', function(reader) {
  console.log('New reader detected:', reader.name);
  
  // Only use ACS readers
  if (!reader.name.includes('ACS')) {
    console.log('Ignoring non-ACS reader:', reader.name);
    return;
  }
  
  // Store reader
  readers[reader.name] = reader;
  
  // Notify all clients about the new reader
  io.emit('readerConnected', { name: reader.name });
  
  /**
   * Handle reader status changes (card insertion/removal)
   */
  reader.on('status', function(status) {
    const changes = this.state ^ status.state;
    
    // Card removed
    if ((changes &amp; this.SCARD_STATE_EMPTY) &amp;&amp; (status.state &amp; this.SCARD_STATE_EMPTY)) {
      io.emit('cardRemoved', { reader: reader.name });
    }
    
    // Card inserted
    if ((changes &amp; this.SCARD_STATE_PRESENT) &amp;&amp; (status.state &amp; this.SCARD_STATE_PRESENT)) {
      // Connect to card
      reader.connect({ share_mode: this.SCARD_SHARE_SHARED }, function(err, protocol) {
        if (err) {
          console.error('Error connecting to card:', err);
          io.emit('error', { message: 'Error connecting to card', error: err.message });
          return;
        }
        
        // Command to get UID (same as in VBA code)
        const command = Buffer.from([0xFF, 0xCA, 0x00, 0x00, 0x00]);
        
        // Send command to card
        reader.transmit(command, 16, protocol, function(err, data) {
          if (err) {
            console.error('Error transmitting to card:', err);
            io.emit('error', { message: 'Error reading card', error: err.message });
            return;
          }
          
          // Format card number
          const cardNumber = formatCardNumber(data);
          
          if (cardNumber) {
            console.log('Card detected:', cardNumber);
            io.emit('cardDetected', { reader: reader.name, cardNumber });
          } else {
            console.error('Invalid card data received');
            io.emit('error', { message: 'Invalid card data received' });
          }
          
          // Disconnect from card
          reader.disconnect(reader.SCARD_LEAVE_CARD, function(err) {
            if (err) {
              console.error('Error disconnecting from card:', err);
            }
          });
        });
      });
    }
    
    this.state = status.state;
  });
  
  /**
   * Handle reader disconnection
   */
  reader.on('end', function() {
    console.log('Reader removed:', this.name);
    delete readers[this.name];
    io.emit('readerDisconnected', { name: this.name });
  });
  
  /**
   * Handle reader errors
   */
  reader.on('error', function(err) {
    console.error('Reader error:', err);
    io.emit('error', { message: 'Reader error', error: err.message });
  });
});

/**
 * Handle PC/SC instance errors
 */
pcscInstance.on('error', function(err) {
  console.error('PCSC error:', err);
  io.emit('error', { message: 'PCSC error', error: err.message });
});

/**
 * Handle new client connections
 * Sends list of available readers to the client
 */
io.on('connection', (socket) => {
  isConnected = true;
  console.log('Client connected, ID:', socket.id);
  console.log('Total connected clients:', io.engine.clientsCount);
  
  // Send list of available readers to the client
  const readerList = Object.keys(readers);
  socket.emit('readers', readerList);
  
  if (readerList.length === 0) {
    console.log('No readers available to send to client');
    socket.emit('error', { 
      message: 'No card readers detected', 
      error: 'Make sure your card reader is connected and recognized by the system' 
    });
  } else {
    console.log('Available readers sent to client:', readerList);
  }
  
  /**
   * Handle client disconnection
   */
  socket.on('disconnect', (reason) => {
    console.log('Client disconnected, ID:', socket.id, 'Reason:', reason);
    console.log('Remaining connected clients:', io.engine.clientsCount);
    
    if (io.engine.clientsCount === 0) {
      isConnected = false;
      console.log('No clients connected');
    }
  });
  
  /**
   * Handle socket errors
   */
  socket.on('error', (error) => {
    console.error('Socket error:', error);
  });
});

/**
 * Handle server connection errors
 */
io.engine.on('connection_error', (err) => {
  console.error('Connection error:', err);
});

/**
 * API endpoint to get list of available NFC readers
 * @route GET /api/readers
 * @returns {Object} JSON object with reader information
 */
app.get('/api/readers', (req, res) => {
  const readerList = Object.keys(readers);
  res.json({ 
    readers: readerList,
    count: readerList.length,
    status: readerList.length > 0 ? 'ok' : 'no_readers',
    connected_clients: io.engine.clientsCount
  });
});

/**
 * API endpoint to get server status
 * @route GET /api/status
 * @returns {Object} JSON object with server status information
 */
app.get('/api/status', (req, res) => {
  res.json({
    status: 'running',
    readers: Object.keys(readers),
    reader_count: Object.keys(readers).length,
    connected_clients: io.engine.clientsCount,
    uptime: process.uptime()
  });
});

/**
 * Error handling middleware
 */
app.use((err, req, res, next) => {
  console.error('Express error:', err);
  res.status(500).json({ error: err.message });
});

/**
 * Start the server on the specified port
 */
const PORT = process.env.PORT || 3001;
server.listen(PORT, (err) => {
  if (err) {
    console.error('Error starting server:', err);
    process.exit(1);
  }
  console.log(`NFC Bridge server running on port ${PORT}`);
  console.log(`API endpoints:`);
  console.log(`- GET http://localhost:${PORT}/api/readers`);
  console.log(`- GET http://localhost:${PORT}/api/status`);
});

/**
 * Handle server errors
 */
server.on('error', (err) => {
  if (err.code === 'EADDRINUSE') {
    console.error(`Port ${PORT} is already in use. Please choose a different port or stop the other process.`);
  } else {
    console.error('Server error:', err);
  }
  process.exit(1);
});

/**
 * Handle process termination
 */
process.on('SIGINT', () => {
  console.log('Shutting down server...');
  server.close(() => {
    console.log('Server stopped');
    process.exit(0);
  });
});
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.4</a> on Sun May 04 2025 17:56:37 GMT-0400 (Eastern Daylight Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
